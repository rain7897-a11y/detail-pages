<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>제품 상세페이지 목록</title>

<style>
body{font-family:system-ui;margin:0;background:#f5f6f8}
.wrap{max-width:960px;margin:40px auto;background:#fff;padding:30px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
h1{margin:0}
.top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px}
.count{font-size:14px;color:#666;text-align:right}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 18px}
input,select{padding:9px 12px;border-radius:10px;border:1px solid #ddd;background:#fff}
.smallnote{font-size:12px;color:#666;line-height:1.5;margin-top:6px}

/* 리스트 */
.item{padding:14px 0;border-bottom:1px solid #eee}
.row{display:grid;grid-template-columns: 1fr 260px;gap:14px;align-items:start}
@media (max-width:720px){
  .row{grid-template-columns: 1fr}
}
.item a{text-decoration:none;font-weight:650;color:#0a58ca}
.item a:hover{text-decoration:underline}
.meta{font-size:12px;color:#777;margin-top:6px}
.badge{display:inline-block;font-size:12px;color:#111;background:#f2f3f5;border:1px solid #e5e7eb;padding:2px 8px;border-radius:999px;margin-right:8px}

.specBox{
  min-height:44px;
  padding:10px 12px;
  border:1px dashed #e5e7eb;
  border-radius:12px;
  background:#fafafa;
  font-size:13px;
  color:#333;
}
.specBox.empty{color:#9aa0a6}
.specTitle{font-size:12px;color:#666;margin-bottom:6px}
</style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <h1>제품 목록</h1>
    <div class="count">
      <div id="count">불러오는 중...</div>
      <div class="smallnote" id="sourceNote"></div>
    </div>
  </div>

  <div class="controls">
    <input type="text" id="search" placeholder="검색 (코드/파일명/제품명/규격)">
    <select id="sort">
      <option value="latest" selected>최신순(코드 내림차순)</option>
      <option value="az">이름순(A→Z)</option>
      <option value="za">이름순(Z→A)</option>
    </select>
  </div>

  <div id="list"></div>

  <div class="smallnote">
    • 표시 데이터는 <b>products.json</b>을 우선 사용합니다. (없으면 GitHub API로 대체)<br>
    • 링크는 <b>코드번호.html</b>만 사용합니다. (한글 URL 미사용)
  </div>

</div>

<script>
/* ===== 설정 ===== */
const BASE = "./";
const PRODUCTS_JSON = "./products.json";
const API  = "https://api.github.com/repos/rain7897-a11y/detail-pages/contents/";

/* ===== 유틸 ===== */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, function(m){
    return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" })[m];
  });
}

// 3436976.html -> 3436976
function getCodeFromCodeOnlyFile(filename){
  const m = String(filename || "").match(/^(\d{3,})\.html$/i);
  return m ? parseInt(m[1], 10) : null;
}

// 3436976_무쇠_...html -> 3436976 (구형 파일명도 지원)
function getLeadingNumber(filename){
  const m = String(filename || "").match(/^(\d{3,})[_-]/);
  return m ? parseInt(m[1], 10) : null;
}

// 이름 정리(앞 번호 제거, 뒤 '상세페이지' 제거)
function cleanLabel(input){
  let s = String(input || "");

  // 확장자 제거
  s = s.replace(/\.html$/i, "");

  // 언더스코어 → 공백 (replaceAll 대신 정규식)
  s = s.replace(/_/g, " ");

  // 맨 앞 번호 제거: (31) / 31 / 31번 / 31. / 31-) 등
  s = s.replace(/^\s*(\(\s*\d+\s*\)|\d+\s*(번|호)?[.)-]?)\s*/i, "");

  // 맨 뒤 "상세페이지" 제거
  s = s.replace(/\s*상세페이지\s*$/i, "");

  // 공백 정리
  s = s.replace(/\s+/g, " ").trim();

  return s;
}

// 표시용 이름 우선순위: name -> title -> file
function displayNameFromItem(it){
  const n = cleanLabel((it && it.name) || "");
  if(n) return n;

  const t = cleanLabel((it && it.title) || "");
  if(t) return t;

  return cleanLabel((it && it.file) || "");
}

/* ===== 전역 ===== */
let allItems = [];

/* ===== 데이터 로드 ===== */
async function loadFromProductsJson(){
  const r = await fetch(PRODUCTS_JSON, { cache: "no-store" });
  if(!r.ok) throw new Error("products.json not found");
  const arr = await r.json();

  const items = (Array.isArray(arr) ? arr : [])
    .map(x => ({
      code: x && x.code != null ? parseInt(x.code, 10) : null,
      file: x && x.file ? String(x.file) : (x && x.code ? (String(x.code) + ".html") : ""),
      title: x && x.title ? String(x.title) : "",
      name: x && x.name ? String(x.name) : "",
      spec: x && x.spec ? String(x.spec) : ""
    }))
    // 코드 + file 형식 최소 검증
    .filter(x => x.code != null && /^\d{3,}\.html$/i.test(x.file));

  items.sort((a,b)=> a.code - b.code);
  return items;
}

async function loadFromGithubApi(){
  const r = await fetch(API, { cache: "no-store" });
  if(!r.ok) throw new Error("GitHub API failed");
  const files = await r.json();

  const items = (Array.isArray(files) ? files : [])
    .filter(f => f && f.name && String(f.name).toLowerCase().endsWith(".html"))
    .filter(f => !["index.html","list.html"].includes(String(f.name).toLowerCase()))
    .map(f => {
      const fname = String(f.name);

      // 1) 코드전용: 3436976.html
      const codeOnly = getCodeFromCodeOnlyFile(fname);
      if(codeOnly !== null){
        return { code: codeOnly, file: fname, title: "", name: "", spec: "" };
      }

      // 2) 구형: 3436976_무쇠_...html
      const lead = getLeadingNumber(fname);
      if(lead !== null){
        // 링크는 코드전용으로 통일 (만약 코드전용 파일이 없다면 404 가능)
        return { code: lead, file: lead + ".html", title: "", name: "", spec: "" };
      }

      return null;
    })
    .filter(Boolean);

  // 중복 코드 제거(앞에 나온 것 우선)
  const seen = {};
  const uniq = [];
  for(let i=0;i<items.length;i++){
    const it = items[i];
    if(seen[it.code]) continue;
    seen[it.code] = true;
    uniq.push(it);
  }

  uniq.sort((a,b)=> a.code - b.code);
  return uniq;
}

/* ===== 초기화 ===== */
(function init(){
  const $count = document.getElementById("count");
  const $note = document.getElementById("sourceNote");

  // 이벤트 먼저 연결(로딩 실패해도 검색창 변경이 에러 안 나게)
  document.getElementById("search").addEventListener("input", applyAndRender);
  document.getElementById("sort").addEventListener("change", applyAndRender);

  (async function(){
    try{
      allItems = await loadFromProductsJson();
      $note.innerHTML = "데이터: <b>products.json</b>";
    }catch(e1){
      try{
        allItems = await loadFromGithubApi();
        $note.innerHTML = "데이터: <b>GitHub API</b> (fallback) — products.json을 추가하면 제품명/규격 표시 가능";
      }catch(e2){
        $count.innerText = "목록 불러오기 실패";
        $note.innerText = "";
        console.error(e1, e2);
        return;
      }
    }

    $count.innerText = "총 " + allItems.length + "개";
    applyAndRender();
  })();
})();

/* ===== 검색/정렬/렌더 ===== */
function applyAndRender(){
  const q = (document.getElementById("search").value || "").toLowerCase().trim();
  const sortMode = document.getElementById("sort").value;

  let list = allItems.slice();

  // 검색: 코드 / 파일명 / 제품명(name) / 규격(spec) / title
  if(q){
    list = list.filter(it=>{
      return String(it.code || "").includes(q)
        || String(it.file || "").toLowerCase().includes(q)
        || String(it.name || "").toLowerCase().includes(q)
        || String(it.spec || "").toLowerCase().includes(q)
        || String(it.title || "").toLowerCase().includes(q);
    });
  }

  // 정렬
  if(sortMode === "latest"){
    list.sort((a,b)=> (b.code||0) - (a.code||0));
  } else if(sortMode === "az"){
    list.sort((a,b)=> displayNameFromItem(a).localeCompare(displayNameFromItem(b), "ko"));
  } else if(sortMode === "za"){
    list.sort((a,b)=> displayNameFromItem(b).localeCompare(displayNameFromItem(a), "ko"));
  }

  render(list);
}

function render(list){
  const box = document.getElementById("list");
  box.innerHTML = "";

  for(let i=0;i<list.length;i++){
    const it = list[i];
    const label = displayNameFromItem(it);
    const spec = (it.spec || "").trim();
    const code = it.code;
    const file = it.file;

    const div = document.createElement("div");
    div.className = "item";

    const specHtml = spec
      ? '<div class="specBox"><div class="specTitle">규격</div>' + escapeHtml(spec) + '</div>'
      : '<div class="specBox empty"><div class="specTitle">규격</div>공란 (products_meta.csv에 입력하면 표시됩니다)</div>';

    div.innerHTML =
      '<div class="row">' +
        '<div>' +
          '<a href="' + (BASE + file) + '" target="_blank" rel="noopener">' + escapeHtml(label) + '</a>' +
          '<div class="meta">' +
            '<span class="badge">코드 ' + escapeHtml(code) + '</span>' +
            '<span>' + escapeHtml(file) + '</span>' +
          '</div>' +
        '</div>' +
        '<div>' + specHtml + '</div>' +
      '</div>';

    box.appendChild(div);
  }

  document.getElementById("count").innerText =
    "표시 " + list.length + "개 / 총 " + allItems.length + "개";
}
</script>

</body>
</html>
