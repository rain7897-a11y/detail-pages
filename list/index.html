<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>상품 목록</title>

<style>
  :root{
    --max:1100px;
    --bg:#f5f6f8;
    --card:#fff;
    --txt:#111827;
    --muted:#6b7280;
    --line:#e5e7eb;
    --accent:#111;
    --chip:#f8fafc;
    --radius:16px;
    --shadow:0 10px 30px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;margin:0;background:var(--bg);color:var(--txt)}
  a{text-decoration:none;color:inherit}
  .wrap{max-width:var(--max);margin:36px auto;padding:0 14px 70px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  .top{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;margin-bottom:12px}
  h1{margin:0;font-size:18px;letter-spacing:-.2px}
  .count{font-size:13px;color:var(--muted);text-align:right}
  .note{font-size:12px;color:var(--muted);line-height:1.55;margin-top:10px}

  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:12px 0}
  input,select,button{
    padding:9px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--txt);
    font:inherit;font-size:13px;
  }
  input{min-width:260px}
  @media (max-width:520px){ input{min-width:100%} }

  .toggle{
    display:flex; align-items:center; gap:8px;
    border:1px solid var(--line); border-radius:12px; overflow:hidden;
    background:#fff;
  }
  .tbtn{
    border:0; border-right:1px solid var(--line);
    padding:9px 10px; background:#fff; cursor:pointer;
    font-size:12px; font-weight:800; color:#111;
  }
  .tbtn:last-child{border-right:0}
  .tbtn.active{background:var(--accent); color:#fff}

  .catbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:0 0 14px}
  .chips{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{
    border:1px solid var(--line);background:var(--chip);color:#111;
    padding:7px 10px;border-radius:999px;font-size:12px;cursor:pointer;user-select:none;
  }
  .chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .chip .n{opacity:.85;margin-left:6px}

  /* 공통 뱃지 */
  .badge{display:inline-block;font-size:12px;color:#111;background:#f2f3f5;border:1px solid var(--line);padding:2px 8px;border-radius:999px}
  .catTag{display:inline-block;font-size:12px;color:#0f172a;background:#eef2ff;border:1px solid #e0e7ff;padding:2px 8px;border-radius:999px}

  /* LIST 모드 */
  .list .item{padding:14px 0;border-bottom:1px solid #eee}
  .list .row{display:grid;grid-template-columns:1fr 280px;gap:14px;align-items:start}
  @media (max-width:760px){ .list .row{grid-template-columns:1fr} }
  .list .alink{font-weight:750;color:#0a58ca}
  .list .alink:hover{text-decoration:underline}
  .meta{font-size:12px;color:#777;margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .specBox{min-height:44px;padding:10px 12px;border:1px dashed var(--line);border-radius:12px;background:#fafafa;font-size:13px;color:#333}
  .specBox.empty{color:#9aa0a6}
  .specTitle{font-size:12px;color:#666;margin-bottom:6px}

  /* GRID 모드 */
  .grid{
    display:grid; grid-template-columns:repeat(4,1fr); gap:10px;
  }
  @media (max-width:980px){ .grid{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:680px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:420px){ .grid{grid-template-columns:1fr} }

  .card{
    border:1px solid var(--line);
    border-radius:14px;
    background:#fff;
    padding:12px;
    transition:transform .06s ease, box-shadow .06s ease;
  }
  .card:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(15,23,42,.08)}
  .thumb{
    height:120px;
    border-radius:12px;
    border:1px dashed var(--line);
    background:linear-gradient(180deg,#fafafa,#f3f4f6);
    display:flex; align-items:center; justify-content:center;
    color:#9aa0a6;
    font-size:12px;
    overflow:hidden;
  }
  .thumb img{width:100%; height:100%; object-fit:cover; display:block}
  .cname{margin-top:10px; font-weight:900; font-size:13px; line-height:1.35}
  .cmeta{margin-top:8px; font-size:12px; color:var(--muted); display:flex; gap:6px; flex-wrap:wrap; align-items:center}
  .price{font-weight:900; color:#111}
  .small{font-size:12px;color:var(--muted)}
</style>
</head>

<body>
<div class="wrap">
  <div class="panel">
    <div class="top">
      <div>
        <h1>상품 목록</h1>
        <div class="small" id="sourceNote"></div>
      </div>
      <div class="count" id="count">불러오는 중...</div>
    </div>

    <div class="controls">
      <input type="text" id="search" placeholder="검색 (코드/파일명/제품명/규격/카테고리)">
      <select id="sort">
        <option value="latest" selected>최신순(코드 내림차순)</option>
        <option value="az">이름순(A→Z)</option>
        <option value="za">이름순(Z→A)</option>
      </select>
      <select id="category">
        <option value="__ALL__" selected>카테고리: 전체</option>
      </select>

      <div class="toggle" title="보기 방식">
        <button class="tbtn" id="btnList" type="button">리스트</button>
        <button class="tbtn" id="btnGrid" type="button">그리드</button>
      </div>
    </div>

    <div class="catbar">
      <div class="chips" id="chips"></div>
    </div>

    <div id="view"></div>

    <div class="note">
      • 데이터는 <b>products.json</b>을 우선 사용합니다. (없으면 GitHub API로 대체)<br>
      • 링크는 <b>코드번호.html</b>만 사용합니다. (한글 URL 미사용)<br>
      • 이미지(썸네일)는 <b>thumb</b> 필드가 있으면 표시하고, 없으면 자리만 보여줍니다.
    </div>
  </div>
</div>

<script>
/* ===== 설정 ===== */
const BASE = "../";                 // /list/index.html 기준: 루트로 올라가서 코드.html 접근
const PRODUCTS_JSON = "../products.json";
const API  = "https://api.github.com/repos/rain7897-a11y/detail-pages/contents/";

/* ===== 유틸 ===== */
function esc(s){
  return String(s||"").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" })[m]);
}
function safeText(s){ return (s==null) ? "" : String(s); }

// ✅ 썸네일 URL을 /list/에서도 안정적으로 보이게 변환
function resolveThumbUrl(src){
  src = String(src||"").trim();
  if(!src) return "";
  // data URI는 제외
  if(/^data:/i.test(src)) return "";

  // 1) 절대 URL(https://...)이면 그대로
  if(/^https?:\/\//i.test(src)) return src;

  // 2) 사이트 절대경로(/img/...)면 그대로
  if(src.startsWith("/")) return src;

  // 3) "./img/a.jpg" 같은 상대경로면 "./" 제거 후 루트 기준으로 올림
  //    현재 페이지는 /list/ 이므로 "../"를 붙이면 루트 기준으로 맞춰짐
  src = src.replace(/^\.\//, "");
  return "../" + src;
}

// 표시용 제목 정리
function cleanLabel(input){
  let s = String(input || "");
  s = s.replace(/\.html$/i, "");
  s = s.replace(/_/g, " ");
  s = s.replace(/\s*\[[^\]]+\]\s*/g, " ");
  s = s.replace(/^\s*(\(\s*\d+\s*\)|\d+\s*(번|호)?[.)-]?)\s*/i, "");
  s = s.replace(/\s*상세페이지\s*$/i, "");
  s = s.replace(/\s+/g, " ").trim();
  return s;
}
function displayNameFromItem(it){
  const n = cleanLabel((it && it.name) || "");
  if(n) return n;
  const t = cleanLabel((it && it.title) || "");
  if(t) return t;
  return cleanLabel((it && it.file) || "");
}

function getCodeFromCodeOnlyFile(filename){
  const m = String(filename || "").match(/^(\d{3,})\.html$/i);
  return m ? parseInt(m[1], 10) : null;
}
function getLeadingNumber(filename){
  const m = String(filename || "").match(/^(\d{3,})[_-]/);
  return m ? parseInt(m[1], 10) : null;
}

/* ===== 카테고리 추정(카테고리 없을 때 fallback) ===== */
function inferCategory(it){
  const explicit = safeText(it && it.category).trim();
  if(explicit) return explicit;

  const text = (safeText(it.name)+" "+safeText(it.title)+" "+safeText(it.spec)+" "+safeText(it.file)).toLowerCase();
  const rules = [
    ["배관자재", ["엘보","티","레듀","레듀샤","소켓","니플","유니온","부싱","캡","플러그","후렌지","플랜지","밸브","피팅","조인트","커플링","pex","pb","pvc"]],
    ["철물/체결", ["볼트","너트","와셔","앙카","앵커","피스","나사","리벳","못","스텐나사","체결"]],
    ["전기자재", ["전선","케이블","콘센트","스위치","차단기","단자","릴레이","led","조명"]],
    ["주방/무쇠", ["무쇠","주철","cast","iron"]],
    ["주방/가마솥", ["가마솥","곰탕","전솥","탕솥","솥뚜껑","솥"]],
    ["주방/팬·그리들", ["그리들","griddle","전골","전골팬","팬"]],
    ["주방/뚝배기·미니", ["뚝배기","미니솥","미니","mini"]],
  ];
  for(const [cat,kws] of rules){
    for(const kw of kws){
      if(text.includes(kw)) return cat;
    }
  }
  return "기타";
}

/* ===== URL 파라미터 ===== */
function getParams(){
  const u = new URL(location.href);
  return {
    q: u.searchParams.get("q") || "",
    sort: u.searchParams.get("sort") || "latest",
    cat: u.searchParams.get("cat") || "__ALL__",
    view: u.searchParams.get("view") || "list" // list | grid
  };
}
function setParams(p){
  const u = new URL(location.href);
  u.searchParams.set("q", p.q || "");
  u.searchParams.set("sort", p.sort || "latest");
  u.searchParams.set("cat", p.cat || "__ALL__");
  u.searchParams.set("view", p.view || "list");
  history.replaceState(null, "", u.toString());
}

/* ===== 전역 ===== */
let allItems = [];
let categoryStats = {};
let currentCategory = "__ALL__";
let currentView = "list";

/* ===== 데이터 로드 ===== */
async function loadFromProductsJson(){
  const r = await fetch(PRODUCTS_JSON, { cache:"no-store" });
  if(!r.ok) throw new Error("products.json not found");
  const arr = await r.json();
  const items = (Array.isArray(arr) ? arr : (arr.products || []))
    .map(x => ({
      code: x && x.code != null ? parseInt(x.code,10) : null,
      file: x && x.file ? String(x.file) : (x && x.code ? (String(x.code)+".html") : ""),
      title: safeText(x && x.title),
      name: safeText(x && x.name),
      spec: safeText(x && x.spec),
      category: safeText(x && x.category),
      brand: safeText(x && x.brand),
      thumb: safeText(x && x.thumb),
      price: (x && x.price != null) ? x.price : null
    }))
    .filter(x => x.code != null && /^\d{3,}\.html$/i.test(x.file));

  items.sort((a,b)=>a.code-b.code);
  return items;
}

async function loadFromGithubApi(){
  const r = await fetch(API, { cache:"no-store" });
  if(!r.ok) throw new Error("GitHub API failed");
  const files = await r.json();

  const items = (Array.isArray(files)?files:[])
    .filter(f=>f && f.name && String(f.name).toLowerCase().endsWith(".html"))
    .filter(f=>!["index.html","list.html"].includes(String(f.name).toLowerCase()))
    .map(f=>{
      const fname = String(f.name);
      const codeOnly = getCodeFromCodeOnlyFile(fname);
      if(codeOnly !== null) return {code:codeOnly, file:fname, title:"", name:"", spec:"", category:"", brand:"", thumb:"", price:null};

      const lead = getLeadingNumber(fname);
      if(lead !== null) return {code:lead, file:(lead+".html"), title:"", name:"", spec:"", category:"", brand:"", thumb:"", price:null};

      return null;
    })
    .filter(Boolean);

  const seen = {};
  const uniq = [];
  for(const it of items){
    if(seen[it.code]) continue;
    seen[it.code] = true;
    uniq.push(it);
  }
  uniq.sort((a,b)=>a.code-b.code);
  return uniq;
}

/* ===== 카테고리 UI ===== */
function buildCategoryStats(){
  const stats = {};
  for(const it of allItems){
    const cat = inferCategory(it);
    it._cat = cat;
    stats[cat] = (stats[cat]||0)+1;
  }
  categoryStats = stats;
}
function fillCategorySelect(){
  const sel = document.getElementById("category");
  sel.innerHTML = '<option value="__ALL__">카테고리: 전체</option>';

  const cats = Object.keys(categoryStats).sort((a,b)=>{
    const da = categoryStats[a]||0, db = categoryStats[b]||0;
    if(db!==da) return db-da;
    return a.localeCompare(b,"ko");
  });

  for(const c of cats){
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = `${c} (${categoryStats[c]})`;
    sel.appendChild(opt);
  }
}
function fillChips(){
  const chips = document.getElementById("chips");
  chips.innerHTML = "";

  const mk = (label, value, count) => {
    const el = document.createElement("div");
    el.className = "chip" + (currentCategory===value ? " active" : "");
    el.innerHTML = esc(label) + `<span class="n">${count}</span>`;
    el.addEventListener("click", ()=>{
      currentCategory = value;
      document.getElementById("category").value = value;
      applyAndRender(true);
      fillChips();
    });
    return el;
  };

  chips.appendChild(mk("전체","__ALL__", allItems.length));

  const cats = Object.keys(categoryStats).sort((a,b)=>{
    const da = categoryStats[a]||0, db = categoryStats[b]||0;
    if(db!==da) return db-da;
    return a.localeCompare(b,"ko");
  });

  for(const c of cats){
    chips.appendChild(mk(c, c, categoryStats[c]));
  }
}

/* ===== 뷰 토글 ===== */
function setView(view){
  currentView = (view==="grid") ? "grid" : "list";
  document.getElementById("btnList").classList.toggle("active", currentView==="list");
  document.getElementById("btnGrid").classList.toggle("active", currentView==="grid");
}

/* ===== 초기화 ===== */
(function init(){
  const params = getParams();

  // 초기값 반영
  document.getElementById("search").value = params.q;
  document.getElementById("sort").value = params.sort;
  currentCategory = params.cat;
  setView(params.view);

  document.getElementById("search").addEventListener("input", ()=>applyAndRender(true));
  document.getElementById("sort").addEventListener("change", ()=>applyAndRender(true));

  document.getElementById("category").addEventListener("change", (e)=>{
    currentCategory = e.target.value;
    applyAndRender(true);
    fillChips();
  });

  document.getElementById("btnList").addEventListener("click", ()=>{
    setView("list");
    applyAndRender(true);
  });
  document.getElementById("btnGrid").addEventListener("click", ()=>{
    setView("grid");
    applyAndRender(true);
  });

  (async function(){
    const $note = document.getElementById("sourceNote");
    const $count = document.getElementById("count");

    try{
      allItems = await loadFromProductsJson();
      $note.innerHTML = '데이터: <b>products.json</b>';
    }catch(e1){
      try{
        allItems = await loadFromGithubApi();
        $note.innerHTML = '데이터: <b>GitHub API</b> (fallback) — products.json을 추가하면 제품명/규격/카테고리 표시가 좋아집니다';
      }catch(e2){
        $count.innerText = "목록 불러오기 실패";
        $note.innerText = "";
        console.error(e1, e2);
        return;
      }
    }

    buildCategoryStats();
    fillCategorySelect();
    fillChips();

    // URL cat 파라미터가 유효하지 않으면 전체로
    if(currentCategory !== "__ALL__" && !categoryStats[currentCategory]){
      currentCategory = "__ALL__";
    }
    document.getElementById("category").value = currentCategory;

    applyAndRender(false);
  })();
})();

/* ===== 검색/정렬/렌더 ===== */
function applyAndRender(updateUrl){
  const q = (document.getElementById("search").value || "").toLowerCase().trim();
  const sortMode = document.getElementById("sort").value;

  let list = allItems.slice();

  // 카테고리 필터
  if(currentCategory && currentCategory !== "__ALL__"){
    list = list.filter(it => (it._cat || inferCategory(it)) === currentCategory);
  }

  // 검색
  if(q){
    list = list.filter(it=>{
      return String(it.code||"").includes(q)
        || String(it.file||"").toLowerCase().includes(q)
        || String(it.name||"").toLowerCase().includes(q)
        || String(it.spec||"").toLowerCase().includes(q)
        || String(it.title||"").toLowerCase().includes(q)
        || String(it._cat||"").toLowerCase().includes(q)
        || String(it.brand||"").toLowerCase().includes(q);
    });
  }

  // 정렬
  if(sortMode === "latest"){
    list.sort((a,b)=> (b.code||0)-(a.code||0));
  }else if(sortMode === "az"){
    list.sort((a,b)=> displayNameFromItem(a).localeCompare(displayNameFromItem(b),"ko"));
  }else if(sortMode === "za"){
    list.sort((a,b)=> displayNameFromItem(b).localeCompare(displayNameFromItem(a),"ko"));
  }

  // URL 동기화
  if(updateUrl){
    setParams({ q, sort: sortMode, cat: currentCategory, view: currentView });
  }

  render(list);
}

function render(list){
  const view = document.getElementById("view");
  view.innerHTML = "";

  // 카운트
  const catLabel = (currentCategory && currentCategory !== "__ALL__") ? currentCategory : "전체";
  document.getElementById("count").innerText =
    `${catLabel} · 표시 ${list.length}개 / 총 ${allItems.length}개`;

  if(currentView === "grid"){
    const grid = document.createElement("div");
    grid.className = "grid";

    for(const it of list){
      const label = displayNameFromItem(it);
      const spec = (it.spec||"").trim();
      const code = it.code;
      const file = it.file;
      const cat = it._cat || inferCategory(it);
      const thumb = (it.thumb||"").trim();
      const price = (it.price!=null && it.price!=="") ? String(it.price) : "";

      const a = document.createElement("a");
      a.className = "card";
      a.href = BASE + file;
      a.target = "_blank";
      a.rel = "noopener";

      const thumbUrl = resolveThumbUrl(thumb);
      const thumbHtml = thumbUrl
        ? `<div class="thumb"><img src="${esc(thumbUrl)}" alt="${esc(label)}" loading="lazy"></div>`
        : `<div class="thumb">이미지 준비중</div>`;

      a.innerHTML = `
        ${thumbHtml}
        <div class="cmeta">
          <span class="catTag">${esc(cat)}</span>
          <span class="badge">코드 ${esc(code)}</span>
        </div>
        <div class="cname">${esc(label)}</div>
        <div class="cmeta">
          ${spec ? `<span>${esc(spec)}</span>` : `<span class="small">규격 미입력</span>`}
          ${price ? `<span class="price">${esc(price)}</span>` : ``}
        </div>
      `;
      grid.appendChild(a);
    }
    view.appendChild(grid);
    return;
  }

  // list 모드
  const box = document.createElement("div");
  box.className = "list";

  for(const it of list){
    const label = displayNameFromItem(it);
    const spec = (it.spec || "").trim();
    const code = it.code;
    const file = it.file;
    const cat = it._cat || inferCategory(it);

    const div = document.createElement("div");
    div.className = "item";

    const specHtml = spec
      ? `<div class="specBox"><div class="specTitle">규격</div>${esc(spec)}</div>`
      : `<div class="specBox empty"><div class="specTitle">규격</div>공란 (products.json에 spec 입력하면 표시됩니다)</div>`;

    div.innerHTML = `
      <div class="row">
        <div>
          <a class="alink" href="${BASE + esc(file)}" target="_blank" rel="noopener">${esc(label)}</a>
          <div class="meta">
            <span class="badge">코드 ${esc(code)}</span>
            <span class="catTag">${esc(cat)}</span>
            <span>${esc(file)}</span>
          </div>
        </div>
        <div>${specHtml}</div>
      </div>
    `;
    box.appendChild(div);
  }

  view.appendChild(box);
}
</script>
</body>
</html>
